# Next.js에서의 Image

## 무엇을 해결할 수 있는가
### 1. **이미지 최적화**  
   300x300 크기의 이미지가 있고, 작은 화면의 디바이스에서는 100x100 크기의 이미지가 필요하다고 가정해 봅시다. 300x300 크기의 이미지를 불러오면 어떤 문제가 발생할까요?

   ### 문제
   - **네트워크 대역폭**:  
     이미지의 크기가 클수록 네트워크 대역폭 사용량이 증가합니다. 따라서 필요 이상으로 큰 이미지를 불러오면 네트워크 대역폭을 과도하게 사용하게 됩니다.
   
   - **데이터 사용량**:  
     모바일 사용자의 경우, 큰 이미지는 데이터 플랜에 영향을 줄 수 있습니다.
     
   - **메모리 사용**:  
     큰 이미지는 더 많은 메모리를 사용할 수 있으며, 특히 메모리가 제한된 장치에서는 성능 저하를 일으킬 수 있습니다.
     
   - **LCP 지표 하락**:  
     Largest Contentful Paint (LCP)는 사용자의 실제 경험을 반영하는 웹 성능의 주요 지표입니다. 페이지가 로드되는 동안 가장 큰 컨텐츠 요소가 사용자의 화면에 나타나기까지 걸린 시간을 나타냅니다. 큰 이미지는 LCP 지표를 하락시킬 수 있습니다.
     
   ### 해결  
   - **이미지 포맷과 압축**:  
       현대적인 이미지 포맷(예: WebP, AVIF)과 압축 기법을 사용하여 이미지 크기를 줄이면, 품질을 크게 손상시키지 않으면서도 대역폭 사용을 줄일 수 있습니다. Next.js에서는 이미지 포맷팅을 지원합니다. 사용법은 다음과 같습니다.
       ```typescript
       // next.config.js
       module.exports = {
        images: {
           formats: ['image/avif', 'image/webp'],
        },
       }
       ```
       AVIF는 Edge에서는 아직 지원하지 않는 포맷입니다. 브라우저가 AVIF를 지원하지 않는 경우, Next.js의 이미지 최적화 기능은 자동으로 브라우저가 지원하는 다른 형식인 WebP를 사용하려고 시도합니다. 이는 브라우저의 `Accept` 헤더를 확인하여 이루어집니다. 브라우저가 어떤 이미지 포맷을 지원하는지 나타내는 `Accept` 헤더에 따라, Next.js는 적절한 포맷의 이미지를 제공합니다.
       
     - **Resolution Switching**:  
       사용자의 디바이스와 화면 크기에 따라 다른 사이즈의 이미지를 제공하는 기법입니다. 이는 불필요한 데이터 전송을 줄이고 로딩 시간을 단축시킵니다. Next.js에서는 `srcSet`과 `sizes` 속성을 관리하여 다양한 해상도의 이미지를 생성하고 적절한 이미지를 로드합니다. 사용자 정의 설정이 필요한 경우, 다음과 같은 config 옵션을 수정할 수 있습니다.
   
       ```typescript
       module.exports = {
        images: {
          imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
          deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
        },
       };
       ```
       `sizes` 속성은 반응형 이미지를 위해 사용되며, 해상도별로 적절한 이미지를 로드할 수 있게 합니다. 기본값이 100vh로 설정되어 있으므로, 이를 고려하지 않으면 큰 이미지가 로드될 수 있습니다.
   
       ```typescript
       import Image from 'next/image'
    
       export default function Page() {
        return (
          <div className="grid-element">
            <Image
              fill
              src="/example.png"
              sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
            />
          </div>
        )
       }
       ```

### 2. **Layout Shift 방지**:  
   사용자의 화면에서 요소들이 갑자기 이동하는 현상을 Layout Shift라고 합니다. 이는 이미지 로딩, 폰트 변경, 동적 컨텐츠 삽입 등으로 인한 DOM의 변화 때문에 발생합니다. 사용자에게 불쾌감을 줄 수 있으며, 웹사이트의 사용성을 저하시킬 수 있습니다.

   ### 문제
   - **사용자 경험 저하**: 사용자가 읽고 있던 내용이나 클릭하려던 버튼이 갑자기 이동하면 사용자는 혼란을 느낄 수 있습니다.
   - **성능 지표 하락**: Layout Shift는 Cumulative Layout Shift(CLS)라는 성능 지표에 영향을 줍니다. 이 지표는 사용자 경험의 안정성을 평가하는 데 사용됩니다.
   - **SEO 영향**: 구글과 같은 검색 엔진은 사용자 경험을 중시하기 때문에, 높은 CLS 점수는 SEO에 부정적인 영향을 줄 수 있습니다.

   ### 해결
   - **이미지 사이즈 명시**: 이미지 로딩으로 인한 Layout Shift를 방지하기 위해, Next.js의 Image 컴포넌트에서는 이미지의 `width`와 `height`를 명시하는 것을 필수로 합니다. 이는 이미지가 로드되기 전에도 해당 공간을 확보하여 레이아웃 변화를 최소화합니다.
     ```typescript
     import Image from 'next/image'
      
     export default function Page() {
     return (
       <Image
         src="/path/to/image"
         alt="Picture of the author"
         width={500}
         height={500}
       />
       )
     }
     ```
   - **fill prop 사용**: `fill` 속성을 사용하면 Image 컴포넌트가 부모 요소의 크기에 맞추어 조절됩니다. 이 방법은 `width`와 `height` 을 미리 알 수 없거나 부모크기의 기준으로 반응형으로 구성할때 유용합니다.
   - **서버에서 이미지 사이즈 조절**: 이미지가 로드되기 전에 서버 측에서 이미지의 크기를 조절하여 저장하면, 클라이언트에서 로드할 때 레이아웃 변화를 최소화할 수 있습니다.
   - **API 요청 시 사이즈 지정**: 이미지를 불러오는 API를 수정하여 요청 시 이미지의 사이즈를 지정할 수 있도록 함으로써, 클라이언트에서 로드할 이미지의 사이즈를 미리 결정할 수 있습니다. 이는 이미지 로딩 시 예상치 못한 레이아웃 변화를 방지하는 데 도움이 됩니다.


### 3. 이미지 레이지 로딩(Lazy Loading)과 Placeholder의 통합 사용

이미지 레이지 로딩은 사용자가 스크롤하여 이미지가 필요할 때까지 이미지 로딩을 지연시키는 기술입니다. 사용자가 처음 페이지를 로드할 때 모든 이미지를 즉시 로드하지 않고, 보이는 부분만 로드하여 초기 로딩 시간을 단축시키고 성능을 향상시킵니다. 이 전략과 함께 `placeholder` 속성과 `blurDataURL`을 사용하면, 이미지가 로드되는 동안 사용자에게 더 나은 시각적 경험을 제공할 수 있습니다.

**문제**:
- **초기 로딩 지연**: 페이지에 많은 이미지가 있을 경우, 모든 이미지를 한 번에 로드하려고 하면 페이지 로딩 시간이 길어질 수 있습니다.
- **데이터 사용량 증가**: 사용자가 실제로 보지 않는 이미지까지 로드하면 불필요하게 데이터 사용량이 증가합니다.
- **서버 부담 증가**: 모든 사용자가 페이지의 모든 이미지를 로드하려고 하면 서버에 불필요한 부담이 가중될 수 있습니다.
- **지연된 시각적 피드백**: 레이지 로딩으로 인해 이미지가 나중에 로드될 때, 사용자는 빈 공간을 볼 수 있으며, 이는 사용자가 페이지에 무언가 누락되었다고 느끼게 할 수 있습니다.

**해결**:
- **`next/image`의 `loading` 속성 사용**: 'lazy' 옵션을 사용하면 이미지가 뷰포트 내에 들어올 때까지 로딩을 지연시킬 수 있습니다.
- **`placeholder` 속성과 `blurDataURL` 사용**: `placeholder="blur"`와 함께 `blurDataURL`을 제공함으로써, 로드되는 동안 낮은 해상도의 블러 이미지를 표시할 수 있습니다.

  ```typescript
  import Image from 'next/image'

  export default function Page() {
    return (
      <div>
        <h1>My page</h1>
        <Image
          src="/path/to/image.jpg"
          alt="Description of the image"
          width={500}
          height={300}
          loading="lazy"
          placeholder="blur"
          blurDataURL="data:image/jpeg;base64,..." // 여기에 블러 이미지의 데이터 URL을 삽입
        />
      </div>
    )
  }
  ```

**주의사항**:
- **사용자 경험**: 레이지 로딩을 적용할 때는 사용자 경험을 주의 깊게 고려해야 합니다.
- **SEO 고려사항**: 레이지 로딩된 이미지는 검색 엔진에 의해 즉시 크롤링되거나 인덱싱되지 않을 수 있습니다.
- **`blurDataURL`의 성능 영향**: 너무 크거나 복잡한 블러 이미지는 추가적인 로딩 시간을 초래할 수 있습니다.
- **접근성 고려**: 이미지에 대한 적절한 대체 텍스트를 제공하는 것은 모든 사용자가 콘텐츠를 이해할 수 있도록 해야 합니다.

이렇게 레이지 로딩과 `placeholder` 및 `blurDataURL`을 함께 사용함으로써, 사용자는 페이지를 더 빠르게 로드하고 로딩 중에도 더 나은 시각적 경험을 얻을 수 있습니다. 동시에, 주의사항을 고려함으로써 더 책임감 있는 방식으로 이 기능들을 활용할 수 있습니다.
